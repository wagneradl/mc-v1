{$DOMAIN} {
    # TLS: Cloudflare Origin Certificate (no auto-ACME)
    tls /etc/caddy/certs/origin.pem /etc/caddy/certs/origin-key.pem

    # Use route for explicit ordering (first match wins)
    route {
        # 1. OAuth discovery endpoints — NO auth required
        reverse_proxy /.well-known/oauth-protected-resource oauth-server:8090
        reverse_proxy /.well-known/oauth-authorization-server oauth-server:8090

        # 2. OAuth flow endpoints — NO auth required
        reverse_proxy /oauth/* oauth-server:8090

        # 3. MCP endpoints — Bearer auth required
        @authorized {
            header Authorization "Bearer {$MCP_BEARER_TOKEN}"
        }
        reverse_proxy @authorized mcp-proxy:8080 {
            flush_interval -1
            transport http {
                read_timeout 0
                write_timeout 0
            }
        }

        # 4. Catch-all — 401
        respond "Unauthorized" 401
    }

    # Logging
    log {
        output file /var/log/caddy/access.log
        format json
    }
}
