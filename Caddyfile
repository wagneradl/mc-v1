{$DOMAIN} {
    # TLS: Cloudflare Origin Certificate (no auto-ACME)
    tls /etc/caddy/certs/origin.pem /etc/caddy/certs/origin-key.pem

    # 1. OAuth discovery + endpoints — NO auth (they ARE the auth mechanism)
    handle /.well-known/oauth-protected-resource {
        reverse_proxy oauth-server:8090
    }

    handle /.well-known/oauth-authorization-server {
        reverse_proxy oauth-server:8090
    }

    handle /oauth/* {
        reverse_proxy oauth-server:8090
    }

    # 2. MCP endpoints — Bearer auth required
    @authorized {
        header Authorization "Bearer {$MCP_BEARER_TOKEN}"
    }
    handle @authorized {
        reverse_proxy mcp-proxy:8080 {
            # SSE-friendly settings
            flush_interval -1
            transport http {
                read_timeout 0
                write_timeout 0
            }
        }
    }

    # 3. Catch-all — 401
    handle {
        respond "Unauthorized" 401
    }

    # Logging
    log {
        output file /var/log/caddy/access.log
        format json
    }
}
